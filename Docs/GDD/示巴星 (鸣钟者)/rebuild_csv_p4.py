#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""Part4: ACT4 (200:00-260:00) with noise meter, perfect dodge heat reduction,
NPC Lyra crisis climax, Sol's recording (empathy #3), world clock collapse"""
import os

CSV = os.path.join(os.path.dirname(os.path.abspath(__file__)), "关卡心流与节奏控制-2.csv")

with open(CSV, 'r', encoding='utf-8') as f:
    existing = f.read().rstrip('\n')

L = []
def r(s=""): L.append(s)

r("")
r(",,,,,,,,")
r("========== ACT 4: 孵化深渊 (200:00-260:00) ==========,,,,,,,,")
r("时长约60分钟 | Z4-Z5 | 世界时钟崩坏+噪音累积槽(非硬潜行)+完美闪避降热+NPC缕拉危机,,,,,,,,")
r("叙事弧：世界在死亡→大静默真相→索尔的遗言→缕拉的抉择+半身黑化 | 世界时钟崩坏=剥夺感,,,,,,,,")
r("关键机制改进：Z4a用噪音累积槽替代硬潜行 / Z4b完美闪避降热(主动vs被动降热互补),,,,,,,,")
r(",,,,,,,,")
r("时段 (Time),区域 (Zone)(Asset),乐章 (Beat)(Narrative),张力(1-10),核心目标 (Objective)(UI Guide),核心障碍 (Obstacle)(The Problem),关键获取 (Acquisition)(The Solution),能力验证 (Verification)(The Test),地图关键点 (POIs)(System/Secret)")

# Z4a - Incubation cavern with NOISE METER (not hard stealth)
r('"200:00-215:00 (900s)","Z4a. 孵化洞穴 (Stealth-lite+Moral)","第八乐章：沉默 (Mvt VIII: Silence)",6,"穿越孵化洞穴/保护幼体/世界时钟崩坏开始","[环境] 大教堂深处的孵化区——数百个发光晶体茧悬挂在穹顶，每个茧中有未出生的鸣钟者幼体。微弱的脉动光芒。[世界时钟崩坏] 涨潮期开始缩短(60秒→45秒→30秒)。退潮期延长(30秒→45秒→60秒)。世界在失去平衡。守夜人:潮汐节律在加速退化...这个世界正在死去。玩家感受到之前依赖的涨潮窗口越来越短——ACT3建立的路径依赖被打破→剥夺感+恐慌感。[噪音累积槽机制(替代硬潜行)] 在孵化区开火→噪音累积槽(Noise/Panic Meter)上升。机制:偶尔开一枪可以容忍(槽上升15%)。连续开火→槽飙升。渐进式后果:30%=周围幼体开始骚动(视觉警告闪烁)。60%=区域局部发狂(2-3个茧破裂释放未成熟腐化者)。100%=全面爆发(所有茧炸裂+大量敌人+道德代价)。停止开火=恐慌值每秒缓慢下降1%→自我修正机会。涟漪(声波脉冲)不增加噪音——鼓励玩家用涟漪探路而非实弹。[敌人] SH-M05静默腐化者x4在洞穴中巡逻(已被感染的成年鸣钟者)。需要在噪音限制下战斗或绕行。[NPC·缕拉与幼体] 缕拉看到茧→深蓝几乎变暗。守夜人:这些是我们的下一代...它们还没学会唱歌就被封在沉默里。缕拉用旋律为附近茧唱摇篮曲→茧微微发光回应。但这消耗大量能量→左臂裂纹向躯干扩散。伊恩:她在拿自己的命给它们唱歌。缕拉辅助:附近茧因摇篮曲稳定不会孵出腐化者(缩小噪音源)。","[棱镜] 流变棱镜·穿透(2023) 精英掉落 对群神器","【验证】1.世界时钟崩坏(涨潮缩短/退潮延长)玩家能感知 2.噪音累积槽UI清晰可见 3.开一枪=15%上升→可容忍 4.连续开火=快速飙升→渐进后果 5.30%视觉警告→60%局部发狂→100%全面爆发 6.停止开火→每秒-1%缓慢恢复 7.涟漪不增加噪音(鼓励探索工具使用) 8.NPC缕拉摇篮曲→茧稳定(间接辅助) 9.裂纹扩散→消逝预兆 10.穿透棱镜获取","[世界时钟] 崩坏开始(涨潮缩短→剥夺感) [噪音累积槽] 替代硬潜行(渐进后果+自我修正) [NPC] 缕拉摇篮曲→裂纹扩散(她在消逝) [棱镜获取] 流变棱镜·穿透 [道德] 全面爆发=幼体全死(不可逆) [涟漪] 不增加噪音=核心探索工具价值 [叙事] N-10:鸣钟者的下一代"')

# Z4b - Silent corridor with PERFECT DODGE HEAT REDUCTION
r('"215:00-230:00 (900s)","Z4b. 静音走廊 (Survival+Horror)","第八乐章：热寂 (Mvt VIII: Heat Death)",8,"穿越静音走廊/完美闪避降热/精英Boss","[环境] 完全被大静默侵蚀的区域——黑色液态金属覆盖墙壁+地面。整个区域是一个巨大的静音力场→热量条自动上升(每秒+1%)。[敌人] SH-M05静默腐化者x6(自带静音力场叠加=靠近时热量+3%/秒)+SH-E02黑水之母(中期精英:巨大黑水实体不断生成腐化者)。[原有降热:共鸣水晶] 走廊中散布3个共鸣水晶(安全但被动)——靠近=热量清零+2秒无敌。但水晶间距较远需要跑过去。[新增:完美闪避降热] 在过热极高时完美闪避(Dash穿过)敌人攻击=瞬间排出15-20%热量。视觉反馈:闪避成功→飞船释放一圈蒸汽/声波涟漪+热量条明显下降+音效正反馈。设计意图:水晶是安全但被动的选择/闪避降热是危险但主动的选择→形成互补。鼓励玩家在高压下敢于和敌人极限交互而不只是逃跑。[精英] SH-E02黑水之母在走廊中段——需要涟漪暴露核心+集中火力。它会不断生成腐化者直到被杀。[世界时钟] 涨潮期几乎消失(只有15秒)。退潮期长达75秒。世界已经接近死亡。","[棱镜] 晕染棱镜·净化(2082) 对黑水类双倍伤害 精英掉落","【验证】1.静音力场→热量自动上升(UI清晰) 2.腐化者叠加→热量飙升压力 3.共鸣水晶→安全但被动降热 4.完美闪避→15-20%瞬间降热(主动) 5.闪避视觉反馈:蒸汽涟漪+热量条下降 6.主动vs被动降热互补选择 7.黑水之母→涟漪暴露核心→集火 8.世界时钟:涨潮15秒/退潮75秒(将死) 9.净化棱镜获取+黑水双倍伤害 10.高手可以纯闪避通关(技巧奖励)","[完美闪避降热] 新机制:Dash穿过攻击=排热15-20% [降热互补] 水晶(安全被动) vs 闪避(危险主动) [精英] SH-E02黑水之母 [棱镜获取] 晕染棱镜·净化 [世界时钟] 几乎消亡(15秒涨潮) [热量系统] 环境+敌人双重加热 [设计意图] 极限交互vs安全逃跑的选择自由"')

# Z4c - Black box room + NPC empathy trigger #3 (Sol's recording)
r('"230:00-245:00 (900s)","Z4c. 黑匣子室 (Narrative Climax)","第九乐章：真相 (Mvt IX: Truth)",3,"发现大静默真相/索尔的遗言/NPC缕拉故事最大危机","[环境] 大教堂最深处的密封档案室——大静默的控制核心。全息投影显示文明最后的记录。[叙事核弹] 黑匣子播放:1.听觉猎手信号确实存在但距离比预估远得多(几百年后才会到达)。2.大静默是基于恐慌的过度反应——不是唯一选项但被选择了。3.指挥家的创建者们知道这一点但仍然选择了沉默——因为对未知的恐惧比理性更强大。[NPC·缕拉共情触发点#3:索尔的遗言] 黑匣子播放中缕拉突然冲到录音设备前——她认出一段音频。守夜人翻译(严重失真):这个声音...这是索尔的声音...他投票时说的话...。录音中索尔的频率(翻译):缕拉...如果你能听到这个...我知道你不会停止歌唱。所以我替你做了选择。原谅我。在沉默中我能保护你。在沉默中听觉猎手找不到你。请活下去。哪怕是无声地。[缕拉的反应] 剧烈颜色变化:赤红(愤怒)→深蓝(悲伤)→极亮金色(决绝)。然后她做了令人心碎的事:**她短暂停止了歌唱**。全场绝对寂静。左臂裂纹以肉眼可见速度扩展——黑色侵蚀半边身体。3秒后重新唱歌但声音虚弱颤抖。守夜人:他一直在保护我...而我一直在恨他的选择...。从此缕拉外观永久改变:半身黑色纹路+核心琥珀光芒微弱。**她在消逝。**[零战斗] 纯叙事段落。","[光帆] 调律帆(自设计) 叙事赠予 冲刺转化敌人攻击为和弦","【验证】1.大静默真相→叙事冲击(听觉猎手距离远) 2.指挥家创建动机→恐惧而非恶意 3.NPC缕拉共情触发点#3(索尔遗言) 4.索尔录音翻译→信号严重失真(情感过载) 5.缕拉停止歌唱→全场寂静→裂纹急剧扩散 6.半身黑化→永久外观改变 7.守夜人翻译:他在保护我→情感高潮 8.调律帆获取 9.零战斗(纯叙事呼吸空间) 10.这是全游戏最具情感冲击力的时刻","[叙事核弹] 大静默真相(恐慌而非必要) [NPC] 缕拉共情触发点#3(索尔遗言→停止歌唱→半身黑化) [光帆获取] 调律帆(转化攻击为和弦) [情感高潮] ACT4最强叙事冲击 [设计意图] 缕拉理解沉默也是爱的表达——但代价是半条命 [零战斗] 张力3/10但叙事张力10/10"')

# Z4d - Ascent + NPC weakened but determined
r('"245:00-260:00 (900s)","Z4d. 上升通道 (Gauntlet+Narrative)","第九乐章：上升 (Mvt IX: Ascension)",7,"冲出深渊/前往钟楼/NPC缕拉最后请求","[环境] 从孵化深渊向上攀升——世界正在加速崩溃。黑水从四面八方涌入。晶体平台在碎裂。[世界时钟终末] 涨潮期完全消失——永恒退潮。世界时钟UI显示归零并闪烁红光。之前所有依赖涨潮的机制全部失效——潮汐门关闭/敌人不再弱化/声波增益消失。玩家感受到彻底的剥夺感。[敌人] 混战:SH-M05x8+SH-M01x10+SH-S02x3。大量敌人但不需要全杀——需要快速突破向上。[光帆新能力] 调律帆:冲刺穿过敌人攻击→转化为和弦冲击波→反伤周围敌人。这是突破的关键。[NPC·缕拉] 虚弱但坚定跟随。歌声断断续续。每当玩家陷入危险→缕拉用最后力量发出高频脉冲→震退附近敌人(每场景限1次/消耗她的生命)。在钟楼前广场:缕拉用微弱旋律表达最后请求。守夜人:帮我...唤醒他...不是用沉默...用一首新歌...一首索尔从未听过的歌...。[过渡] 钟楼在眼前——巨大倒置钟形建筑。顶部发出不祥的低频共鸣。","[伴星] 护盾无人机(4002) 探索奖励 最终战前防御补充","【验证】1.世界时钟归零→永恒退潮(所有涨潮机制失效) 2.玩家感受彻底剥夺(之前的安全节奏全没了) 3.调律帆冲刺转化攻击→突破利器 4.快速向上突破(不需全杀) 5.NPC缕拉高频脉冲(每场景1次) 6.缕拉虚弱描写(歌声断续/半身黑纹) 7.最后请求:用新歌唤醒索尔 8.护盾无人机获取 9.钟楼全景→ACT5预告","[世界时钟终末] 归零/永恒退潮(彻底剥夺) [调律帆实战] 冲刺转化攻击 [NPC] 缕拉高频脉冲(牺牲生命)+最后请求 [伴星获取] 护盾无人机 [设计意图] 从最深的绝望向上攀升→ACT5 [过渡] 钟楼→最终Boss"')

r(",,,,,,,,")
r("ACT4 心流曲线(60min):,,,,,,,,")
r(" 200:00  ██████░░░░ 6/10 [沉默] 噪音累积槽(非硬潜行)+世界时钟崩坏+NPC摇篮曲,,,,,,,,")
r(" 215:00  ████████░░ 8/10 [热寂] 静音走廊+完美闪避降热+黑水之母精英,,,,,,,,")
r(" 230:00  ███░░░░░░░ 3/10 [真相] ★叙事核弹★大静默真相+索尔遗言+NPC缕拉半身黑化(共情#3),,,,,,,,")
r(" 245:00  ███████░░░ 7/10 [上升] 世界时钟归零+调律帆突破+NPC缕拉最后请求,,,,,,,,")
r("ACT4总结:世界时钟崩坏产生强烈剥夺感。噪音累积槽+完美闪避降热替代硬性限制。NPC缕拉经历最大危机(索尔遗言→半身黑化→消逝预兆)。,,,,,,,,")

with open(CSV, 'w', encoding='utf-8') as f:
    f.write(existing + "\n".join(L) + "\n")
print(f"Part4 OK: added {len(L)} rows")

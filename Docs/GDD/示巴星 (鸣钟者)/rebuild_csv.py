#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""Rebuild the complete Sheba CSV with ALL planned modifications:
- NPC Lyra (缕拉) integration across ACT 1-5
- ACT3 breathing room node (Z3d-bis)
- World clock enhancements (earlier foreshadowing + more dependency scenes)
- Z4a noise meter instead of hard stealth
- Ripple as independent interaction tool
- Simplified Z3c boss pacification
- Z4b perfect dodge heat reduction
- Z6c visual telegraph system
"""
import os

CSV = os.path.join(os.path.dirname(os.path.abspath(__file__)), "关卡心流与节奏控制-2.csv")
L = []
def r(s=""): L.append(s)

# ===== HEADER =====
r("========== 示巴星 (Sheba) 完整关卡体验设计 ==========,,,,,,,,")
r("总时长约5小时(300分钟) | 结构三幕五章 | 双螺旋型(战斗线x叙事线交织上升),,,,,,,,")
r("NPC：缕拉(Lyra)——最后的调音师。贯穿ACT1-5的鸣钟者NPC。详见NPC-鸣钟者角色设定.md,,,,,,,,")
r(",,,,,,,,")

# ===== ARCHITECTURE =====
r("【整体架构概览】,,,,,,,,")
r("第一幕：不协和音(Dissonance)约90min — 从噪音入侵者到开始理解世界,,,,,,,,")
r("  ACT1 坠落与觉醒(0:00-50:00) Z1坠机冰原 | 双武器+基础战斗 | NPC缕拉间接线索+首次目击,,,,,,,,")
r("  ACT2 叹息的峡谷(50:00-90:00) Z2叹息峡谷 | 涟漪(独立交互工具)+环境解谜 | NPC缕拉首次面对面,,,,,,,,")
r("第二幕：高烧状态(Fever State)约110min — 难度攀升+新敌人+道德选择+NPC深度合作,,,,,,,,")
r("  ACT3 回音枢纽(90:00-200:00) Z3回音大教堂 | 棱镜+光帆+调律净化 | 世界时钟(潮汐)系统+NPC缕拉合作,,,,,,,,")
r("第三幕：终止式(The Cadence)约100min — 世界崩溃+最终对决+NPC故事高潮,,,,,,,,")
r("  ACT4 孵化深渊(200:00-260:00) Z4-Z5 | 噪音累积槽+完美闪避降热 | NPC缕拉危机+大静默真相,,,,,,,,")
r("  ACT5 哭泣钟楼(260:00-310:00) Z6最终Boss | 视觉电报系统+星际即兴曲 | NPC缕拉最终牺牲+上船,,,,,,,,")
r(",,,,,,,,")

# ===== STAR CHART =====
r("【星图部件获取规划(共13件)】,,,,,,,,")
r("章节,时间点,部件类型,名称,设计用意,,,,")
sc = [
    ("ACT1 0:00","开场自带","星核x2","实弹(机枪)+重炮(副武器)","基础双武器系统"),
    ("ACT1 35:00","战斗奖励","棱镜x1","分形棱镜·双生(2001)","第一个改装:子弹+2"),
    ("ACT2 55:00","精英掉落","星核x1","涟漪(声波弹/独立交互工具)","核心能力:独立快捷键环境工具非武器槽位"),
    ("ACT2 80:00","探索奖励","棱镜x1","流变棱镜·反弹(2013)","利用峡谷反弹特性"),
    ("ACT3 110:00","叙事赠予","棱镜x1","晕染棱镜·霜冻(2004)","控制:减速效果"),
    ("ACT3 130:00","Boss掉落","光帆x1","共鸣光帆(自设计)","冲刺释放和谐声波净化黑水"),
    ("ACT3 160:00","探索奖励","伴星x1","自动机炮(4001)","第一个伴星"),
    ("ACT4 210:00","精英掉落","棱镜x1","流变棱镜·穿透(2023)","对群神器"),
    ("ACT4 230:00","叙事赠予","棱镜x1","晕染棱镜·净化(2082)","对黑水类双倍伤害"),
    ("ACT4 250:00","Boss掉落","光帆x1","调律帆(自设计)","冲刺转化敌人攻击为和弦"),
    ("ACT5 270:00","探索奖励","伴星x1","护盾无人机(4002)","最终战前防御补充"),
    ("ACT5 290:00","Boss掉落","星核x1","星图碎片:示巴","通关解锁下一星球"),
    ("ACT5 可选","隐藏收集","棱镜x1","熵增棱镜·回声(2106)","隐藏收集奖励"),
]
for s in sc:
    r(f"{s[0]},{s[1]},{s[2]},{s[3]},{s[4]},,,,")
r(",,,,,,,,")

# ===== ENEMY BESTIARY =====
r("【敌人图鉴(示巴星特化版)】,,,,,,,,")
r("ID,类型,名称,原型,核心机制,首次出现,设计灵感,,")
en = [
    ("SH-M01","杂兵","碎晶爬行者","Rusher","自杀冲锋+死亡玻璃雨AOE","ACT1 5:00","海胆+碎玻璃"),
    ("SH-M02","杂兵","静滞浮雷","Kiter","悬浮球形水雷+涟漪可使其休眠","ACT1 15:00","水母+地雷"),
    ("SH-M03","杂兵-中立","歌唱爬行者","Neutral","不攻击原地歌唱/杀它=沉默一个声音","ACT1 30:00","音叉+萤火虫"),
    ("SH-M04","杂兵-远程","共振尖叫者","Kiter","蓄力高频声波束+升调预警+瞄准线","ACT2 55:00","音叉+狙击手"),
    ("SH-S01","特化-反制","坚盾歌者","Reflector","钟形正面波纹盾(反弹)/绕背或涟漪穿透","ACT2 65:00","教堂钟+盾牌兵"),
    ("SH-S02","特化-机动","相位漫步者","Stalker","声波短距瞬移/渐弱期隐形/攻击后闪现","ACT3 100:00","唱片跳针+忍者"),
    ("SH-S03","特化-环境","黑水触手","Turret/Trap","从黑水伸出抓人拖入(即死)/涟漪净化退缩","ACT3 120:00","深海章鱼+陷阱"),
    ("SH-M05","杂兵-变异","静默腐化者","Rusher(Berserk)","被大静默感染/身体发黑疯狂/静音力场导致过热","ACT4 205:00","僵尸+黑水"),
    ("SH-E01","精英","金色指挥者","Mini-Boss","指挥杂兵合唱编队(BUFF)/击杀瓦解编队","ACT2 70:00","交响乐指挥+将军"),
    ("SH-E02","精英","黑水之母","Mini-Boss","巨大黑水实体/不断生成腐化者/需涟漪暴露核心","ACT4 220:00","深海水母+孵化器"),
    ("SH-W01","游荡Boss","破碎的守夜人","Nemesis","战损巨型鸣钟者/特定区域随机追杀","ACT3 115:00","魂系NPC入侵"),
    ("SH-B01","区域Boss","叹息墙之心","PhaseScript","三阶段:晶体盾+黑水→暴露核心+召唤群→狂暴+静音","ACT2 85:00","教堂大门+免疫系统"),
    ("SH-B02","最终Boss","大指挥家","PhaseScript","不是对轰是合奏/音符攻击有视觉电报/在乐章间隙插入变奏","ACT5 290:00","管风琴+悲剧AI"),
]
for e in en:
    r(f"{e[0]},{e[1]},{e[2]},{e[3]},{e[4]},{e[5]},{e[6]},,")
r(",,,,,,,,")
r(",,,,,,,,")

# ===== ACT 1 (with NPC Lyra integration) =====
r("========== ACT 1: 坠落与觉醒 (0:00-50:00) ==========,,,,,,,,")
r("时长约50分钟 | Z1坠机冰原 | 从无知的破坏者到开始倾听,,,,,,,,")
r("叙事弧：噪音降临→学会战斗→发现敌人不是怪物→质疑暴力 | NPC缕拉：间接线索→首次目击,,,,,,,,")
r(",,,,,,,,")
r("时段 (Time),区域 (Zone)(Asset),乐章 (Beat)(Narrative),张力(1-10),核心目标 (Objective)(UI Guide),核心障碍 (Obstacle)(The Problem),关键获取 (Acquisition)(The Solution),能力验证 (Verification)(The Test),地图关键点 (POIs)(System/Secret)")

# Z1a
r('"0:00-5:00 (300s)","Z1a. 坠机点 (Cinematic→Linear)","序曲：坠落 (Overture: The Fall)",4,"逃离坠机现场+双武器教学","[过场] 10秒CG:金丝雀号被晶体星环碎片击中螺旋坠落→无缝衔接gameplay。[环境] 发光晶体碎片从天空飘落。[敌人] 爆炸声波惊醒2只碎晶爬行者从冰面裂缝爬出。[叙事] 伊恩紧急通讯:你降落在了一个不该有声音的地方。","[主武器:实弹(机枪)] + [副武器:重炮] 从坠机残骸拾取。星图UI首次弹出。","【验证】1.CG→gameplay无缝 2.3秒后移动解锁 3.30秒后冲刺解锁 4.60秒后拾取主武器 5.星图UI拖拽教学 6.2只爬行者射击教学(3-4发击杀) 7.敌人死亡崩解为音符光点+风铃声 8.副武器击碎大型冰柱","[锚点A] 坠机点(残骸坍塌不可返回) [叙事] N-01触发 [音效] 爆炸→3秒绝对寂静→风声 [视觉] 冷冽青蓝色天空+远处倒置钟楼剪影 [5分钟完成全部基础教学]"')

# Z1b - NPC: indirect clue (warm ice sculpture)
r('"5:00-12:00 (420s)","Z1b. 寂静雪原 (Open→Guided)","第一乐章：寂静 (Mvt I: Silence)",2,"探索冰原/感受安静/发现冰雕群","[纯探索] 广袤惨白冰原。断裂音叉树如墓碑。银色硅基粉尘随风成克拉德尼图案。[无威胁] 零敌人。风声+脚踩碎玻璃咔嚓声。[引导] 远处7座冰雕散发彩色微光。[互动] 射击断裂音叉树→发出单音符(建立射击=声音)。[伏笔] 地面偶尔渗出黑水+踩上去声音被吞噬。[NPC伏笔·缕拉] 冰雕群中有一座比其他更新——表面温暖微微发光如有人最近来过并触摸过它。守夜人:这里有一个活的信号源...但它在快速远去。","[无新获取] (纯探索段) 星图补给仓(HP/弹药)","【验证】1.开放冰原3个兴趣点 2.射击音叉树桩每棵音高不同(Do-Re-Mi) 3.7座冻结鸣钟者冰雕如在演奏 4.靠近→微弱残留旋律 5.主武器射击冰雕→冰壳碎裂释放旋律+历史全息 6.温暖的冰雕(NPC伏笔)→守夜人检测到活体频率 7.全部7座=完整文明主题曲(可选成就) 8.守夜人:它们曾经是一个乐队","[锚点B] 冰雕群中心(安全区) [Lore] 冰雕x7(旋律碎片=鸣钟者七章史) [秘密] 按Do-Mi-Sol-Do射击→第8座升起 [NPC伏笔] 温暖冰雕+活体频率信号=缕拉曾来过 [氛围] BGM极简 [7分钟安静=用缺失制造好奇]"')

# Z1c
r('"12:00-22:00 (600s)","Z1c. 觉醒战场 (Arena Sequence)","第一乐章：暴力 (Mvt I: Violence)",7,"消灭爬行者/保护冰雕群","[触发] 第7座冰雕旋律扩散→远山变紫红(N-02)。[伊恩] 你的声音引来了它们。[三波] Wave1:5只SH-M01分散冲锋→Wave2:8只SH-M01+2只SH-M02半包围→Wave3:10只SH-M01+1只金色精英SH-E01直奔最大冰雕。[机制] 爬行者优先攻击冰雕。[选择] 保护(高难/保留Lore) vs 放弃(低难/失去收集)。","[无新获取] 双武器实战验证。实弹:高射速清群。重炮:高伤对精英。","【验证】1.Wave1基础射击+走位 2.过热教学 3.Wave2浮雷飘向冰雕需优先击破 4.引爆时机(引到怪群) 5.Wave3精英指挥锁定最大冰雕 6.副武器对精英效果显著 7.精英死亡释放金色音波→震散杂兵(快杀奖励) 8.清点冰雕存活→影响后续对话","[战斗] 保护目标式三波 [叙事] N-02:天空变色 [精英] SH-E01弱化版 [后果] 冰雕存活→信任度 [奇遇] 全存活→冰雕合奏完整旋律(情感奖励)"')

# Z1d - NPC: flower trail clue
r('"22:00-32:00 (600s)","Z1d. 音叉林 (Exploration+Tutorial)","间奏曲：回声 (Intermezzo: Echo)",4,"穿越音叉林/遭遇奇妙生态","[环境] 密集音叉林——巨大金属树干直入云霄。[声学] 靠近音叉树→重力减弱→跳跃更高/滞空更长。[互动] 射击音叉树→共鸣波(3秒)→震晕附近爬行者(环境武器)。[生态] 克拉德尼花——银色硅基植物随声音绽放/闭合。[敌人] 零星SH-M01x3-4+隐藏SH-M02x1。[奇妙遭遇] 林间深处:休眠的巨型鸣钟者(非敌对)。半透明身体内可见跳动钟摆心。靠近→嗡鸣→花朵全部绽放。[NPC伏笔·缕拉] 地面有一串奇特花路——克拉德尼花沿某条路径绽放。有人最近经过+歌声让沿途花全开了。花路指向峡谷深处。","[无新获取] 环境互动教学。音叉树=环境武器。重力变化=探索。","【验证】1.进入音叉林重力变轻 2.射击音叉树→共鸣波震晕爬行者 3.减重跳上高处→补给+Lore 4.射击克拉德尼花→绽放成临时平台(3秒) 5.隐藏浮雷从花丛探出 6.遭遇休眠巨型鸣钟者→伊恩:它还活着! 7.不可攻击(弹开)→不是所有鸣钟者都是敌人 8.发现花路(NPC伏笔)→伊恩:有人在这里唱过歌","[锚点C] 巨型鸣钟者·花园(安全区/存档) [教学] 共鸣波+声悬浮 [生态] 克拉德尼花(声音→绽放→平台) [奇遇] 休眠巨型鸣钟者(NPC式) [NPC伏笔] 克拉德尼花路=缕拉的足迹 [秘密] 对巨型鸣钟者用重炮→痛苦收缩+伊恩训斥 [Lore] 鸣钟者音叉农业"')

# Z1e
r('"32:00-38:00 (360s)","Z1e. 战后余波 (Narrative Aftermath)","第二乐章：反思 (Mvt II: Reflection)",3,"清点战果/认知转折","[发现] 爬行者碎片也发出微弱旋律(和冰雕一样!)。[叙事转折] 守夜人:这些爬行者不是入侵者——它们是鸣钟者自己的碎片。你射杀的每一只都曾是文明的一个音符。[互动] 射击碎片→旋律释放后消散。[情感] 2只休眠爬行者蜷缩在音叉树下(不攻击)。姿态如在哭泣。[引导] 碎片组成旋律之路→引向峡谷。","[无新获取] 认知重定义:敌人=走调的鸣钟者碎片。","【验证】1.检查碎片→旋律残留 2.守夜人分析→敌人真实身份 3.伊恩:我们一直在杀死它们的记忆? 4.休眠爬行者→安静时的敌人(保护性姿态) 5.射击休眠者→不反击只哀鸣消散(负罪感) 6.旋律之路→碎片音符画克拉德尼图案 7.纯叙事无战斗 8.远处巨型鸣钟者似在苏醒(伏笔)","[叙事] 核心认知转折:敌人=走调碎片 [NPC] 休眠爬行者x2 [伏笔] 巨型鸣钟者苏醒 [情感] 我是不是做错了? [设计意图] 战后寂静放大反思——暴力后的虚无"')

# Z1f - NPC: first sighting of Lyra
r('"38:00-50:00 (720s)","Z1f. 下行通道→Z2 (Gauntlet+Puzzle)","第二乐章：觉悟 (Mvt II: Awakening)",6,"保护歌唱者/获取首个棱镜","[地形] 下坡进入管风琴峡谷入口通道——水晶管壁(子弹击中发出音阶)。[敌人] 攻击型SH-M01x6+歌唱型SH-M03x2(首次!)。[道德] 歌唱型不攻击。攻击型正在摧毁它们![选择] A.全杀(快) B.保护歌唱者+只杀攻击型(难有奖励)。[环境] 射击特定管壁→共鸣波区域震晕。[精英] 通道末端金色指挥者SH-E01→指挥围攻歌唱者。[奖励] 击败精英→掉落分形棱镜·双生(2001)。[NPC·缕拉首次目击] 击败精英获得棱镜后短暂安静中远处传来微弱旋律——不是环境音是有意识的生物在唱歌。镜头拉远:峡谷另一侧高崖上有一个淡金色小型身影在悬浮。它看了玩家一眼(闪了翠绿色=好奇)然后迅速飘走消失在岩壁缝隙。伊恩:等等...那是一个鸣钟者?但它...不一样。它在唱歌。","[棱镜] 分形棱镜·双生(2001) 效果:+2颗子弹 占位:1槽+5热量 第一个改装!","【验证】1.远处歌声和尖叫混杂 2.发现歌唱型被攻击型包围 3.守夜人:保护还记得旋律的! 4.精准射击避免误伤 5.管壁共鸣波震晕3秒 6.精英指挥编队→优先击杀 7.掉落棱镜→星图改装教学 8.装备双生→射击变3发(正反馈!) 9.歌唱者存活→唱旋律→隐藏门 10.NPC缕拉首次目击→淡金色身影+远方旋律","[棱镜获取] 分形棱镜·双生 [教学] 棱镜系统+星图改装 [道德] 歌唱型(保护/忽视/杀→不同后果) [环境] 管壁共鸣波 [精英] 金色指挥者 [NPC] 缕拉首次目击(淡金色身影+翠绿=好奇) [秘密] Do-Mi-Sol-Do密码 [过渡] 峡谷全景→ACT2预告"')

r(",,,,,,,,")
r("ACT1 心流曲线(50min):,,,,,,,,")
r("  0:00  ████░░░░░░ 4/10 [序曲] CG坠机+逃跑+双武器获取,,,,,,,,")
r("  5:00  ██░░░░░░░░ 2/10 [寂静] 冰原探索+冰雕旋律+NPC伏笔(温暖冰雕),,,,,,,,")
r(" 12:00  ███████░░░ 7/10 [暴力] 三波保护战斗——首次真正考验,,,,,,,,")
r(" 22:00  ████░░░░░░ 4/10 [回声] 音叉林+生态惊奇+NPC伏笔(花路),,,,,,,,")
r(" 32:00  ███░░░░░░░ 3/10 [反思] 战后余波+认知转折——情感冲击,,,,,,,,")
r(" 38:00  ██████░░░░ 6/10 [觉悟] 道德选择+首棱镜+NPC缕拉首次目击,,,,,,,,")
r("ACT1总结:从无知破坏者到开始倾听。NPC缕拉以间接线索(温暖冰雕+花路)和首次远距目击建立神秘感。,,,,,,,,")

with open(CSV, 'w', encoding='utf-8') as f:
    f.write("\n".join(L) + "\n")
print(f"Part1 OK: {len(L)} rows")

#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""Part5: ACT5 (260:00-310:00) with visual telegraph system for final boss,
NPC Lyra final sacrifice + boarding, and full summary"""
import os

CSV = os.path.join(os.path.dirname(os.path.abspath(__file__)), "关卡心流与节奏控制-2.csv")

with open(CSV, 'r', encoding='utf-8') as f:
    existing = f.read().rstrip('\n')

L = []
def r(s=""): L.append(s)

r("")
r(",,,,,,,,")
r("========== ACT 5: 哭泣钟楼 (260:00-310:00) ==========,,,,,,,,")
r("时长约50分钟 | Z5-Z6 最终Boss+结局 | 视觉电报系统+NPC缕拉最终牺牲+上船,,,,,,,,")
r("叙事弧：最终对决→星际即兴曲→索尔苏醒→缕拉上船→新旅程 | 视觉电报:视觉>听觉,,,,,,,,")
r(",,,,,,,,")
r("时段 (Time),区域 (Zone)(Asset),乐章 (Beat)(Narrative),张力(1-10),核心目标 (Objective)(UI Guide),核心障碍 (Obstacle)(The Problem),关键获取 (Acquisition)(The Solution),能力验证 (Verification)(The Test),地图关键点 (POIs)(System/Secret)")

# Z5a - Pre-boss preparation
r('"260:00-275:00 (900s)","Z5a. 钟楼前广场 (Arena+Preparation)","第十乐章：决意 (Mvt X: Resolve)",8,"阵营交战/准备最终战/NPC缕拉集结","[环境] 钟楼前广场——巨大的开阔空间。地面是完整的克拉德尼花图案(已枯萎)。钟楼入口被指挥家的黑水屏障封死。[战斗] 阵营交战:指挥家的腐化军(SH-M05x10+SH-S01x4+SH-E01x2)vs 玩家+歌唱者合唱队。这是ACT3保护的歌唱者发挥作用的时刻——它们用合唱产生声波屏障保护玩家侧翼。[NPC·缕拉] 虚弱的缕拉站在歌唱者中间努力指挥。她的旋律越来越微弱但歌唱者们围绕在她身边——它们在保护她就像她一直在保护它们。守夜人:它们知道她快要...。缕拉用最后的力量发出一声高频脉冲→钟楼黑水屏障出现裂痕。伊恩:一个人的声音打不破沉默。但你不是一个人。[关键机制] 玩家需要在战斗中保护歌唱者合唱阵列——如果阵列被破坏屏障无法打破。调律帆冲刺穿过敌群→转化攻击→反馈给歌唱者→合唱增强→屏障裂痕扩大。","[无新获取] 最终战准备","【验证】1.阵营交战→大规模战斗 2.歌唱者合唱屏障(ACT3保护的回报) 3.保护合唱阵列+战斗双线操作 4.缕拉指挥(虚弱但坚持) 5.调律帆转化→合唱增强→屏障破裂 6.钟楼入口打开 7.NPC缕拉虚弱描写(消逝加速) 8.伊恩金句:你不是一个人","[阵营交战] 大规模腐化军vs合唱队 [NPC] 缕拉虚弱指挥+高频脉冲破屏障 [歌唱者回报] ACT3保护的投资回报 [调律帆] 转化攻击→合唱增强 [叙事] N-11:最终集结 [过渡] 钟楼入口开启→最终Boss"')

# Z5b - Tower interior
r('"275:00-290:00 (900s)","Z5b. 钟楼内部 (Vertical Gauntlet)","第十乐章：攀登 (Mvt X: Climb)",9,"攀登钟楼/突破最后防线","[环境] 倒置钟楼内部——向下延伸的螺旋结构(视觉上是向上攀登)。每层有不同的声学特性。[战斗] 每层一个精英+杂兵群。层1:SH-S02x4相位漫步者(无涨潮永久隐形→只能靠涟漪显形)。层2:SH-S03x3黑水触手+SH-M05x6(光帆净化+穿透棱镜清群)。层3:SH-E02黑水之母变体(更强→需要调律帆转化其攻击)。[关键] 每层完成→激活一个钟摆→钟楼发出一声低沉的钟鸣(为最终Boss战做铺垫)。三声钟鸣后顶部大门开启。[NPC·缕拉] 缕拉无法跟随战斗但在每层入口等待。每次通过→她用剩余力量为玩家短暂恢复热量(清零)。她的身体越来越暗——黑色纹路覆盖了3/4。核心琥珀光芒仅剩指尖大小。","[无新获取] 全能力终极考验","【验证】1.三层递进难度 2.层1:涟漪显形→射击(无涨潮挑战) 3.层2:光帆净化+穿透清群 4.层3:调律帆转化攻击 5.每层钟摆激活+钟鸣(仪式感) 6.NPC缕拉每层恢复热量(消耗自身) 7.缕拉外观持续恶化(3/4黑化) 8.三声钟鸣→大门开启→最终Boss","[垂直关卡] 钟楼三层递进 [全能力验证] 涟漪+光帆+调律帆+棱镜+伴星 [NPC] 缕拉恢复热量(牺牲自身) [仪式] 三声钟鸣 [设计意图] 最终Boss前的能力大考"')

# Z5c - FINAL BOSS with VISUAL TELEGRAPH SYSTEM
r('"290:00-310:00 (1200s)","Z5c. 最终Boss：大指挥家 (Final Boss Arena)","终章：星际即兴曲 (Finale: Cosmic Improvisation)",10,"击败/拯救大指挥家/NPC缕拉最终牺牲+上船","[Boss] SH-B02大指挥家——不是传统对轰而是一场音乐会。Boss在钟楼顶部的巨大管风琴前指挥。三个阶段=三个乐章。[视觉电报系统(核心设计)] 所有Boss攻击同时拥有音频+视觉信号。视觉信号必须比音频早0.5-1秒出现。遵循Signal-Window模式。不依赖听觉仅通过视觉即可辨别所有弹幕类型。三种攻击: 高音攻击(天降晶体)=屏幕上方闪烁锐利亮蓝色光芒→0.5秒后晶体从天降落。 低音攻击(地震波)=地面涌动厚重暗红色波纹→0.5秒后地面裂开释放冲击波。 和弦攻击(全屏冲击)=屏幕四周出现收缩的金色边框线→1秒后全屏声波冲击(需冲刺无敌帧躲避)。[P1独奏(290:00-295:00)] 指挥家solo——三种攻击交替。玩家学习视觉电报+找攻击间隙输出。Boss台词(翻译):你们带来了噪音。噪音引来猎手。我必须让一切安静。[P2协奏(295:00-302:00)] 歌唱者加入玩家阵营形成乐队。合唱产生声波护盾+增益。NPC缕拉用最后力量加入——她的旋律让增益从x2提升到x3。但每演奏10秒→黑色纹路扩展一分。指挥家的攻击更复杂:高音+低音同时(蓝色上方+红色地面→需站在中层)/和弦+高音组合(金色边框+蓝色上方→冲刺后立即走位)。[P3即兴曲/双路线(302:00-310:00)] 毁灭路线:继续输出打到血量归零→指挥家崩溃→管风琴碎裂→大静默彻底解除但无序。拯救路线:用调律帆冲刺穿过指挥家的攻击→转化为和弦→反馈给歌唱者→合唱产生从未存在过的新旋律。NPC缕拉将第七声部频率注入和弦——新歌=缕拉的即兴+玩家的噪音+歌唱者的和声。指挥家被新歌打动→停止攻击→对话:这首歌...不在我的乐谱上...但它...很美。[关键时刻] 大钟内晶体茧碎裂→微弱频率传出→那是索尔的基音。索尔没有死——他把自己封印在茧中成为保护幼体的地基。缕拉用尽全部剩余能量发出震彻钟楼的单音——与索尔完美共振。茧破碎。索尔以新形态苏醒(半晶体半有机)。[上船结局] 战后缕拉身体几乎全部黑化仅剩核心一点琥珀光。索尔苏醒→用基音稳定缕拉核心(暂停侵蚀)。但只有持续的新声场才能维持她。缕拉选择登上金丝雀号——飞船引擎声能提供持续声场维持生存。索尔留下成为新生示巴星的第一声部。量子共振保持跨星际联系——缕拉唱歌索尔就能听到。最后一刻:缕拉回望示巴星唱了Do→索尔回应Sol→两音交汇形成完美五度和声。伊恩:这是告别吗?守夜人:不。这是约定。","[星核] 星图碎片:示巴 通关解锁下一星球","【验证】1.视觉电报:高音=蓝色上方0.5秒预警 2.视觉电报:低音=红色地面0.5秒预警 3.视觉电报:和弦=金色边框1秒预警 4.不依赖听觉仅视觉即可辨别所有弹幕(可读性验收) 5.Signal-Window模式(信号→窗口→判定) 6.P1三种攻击独立教学 7.P2组合攻击+歌唱者增益 8.P3双路线(毁灭/拯救) 9.NPC缕拉注入第七声部→新歌 10.索尔苏醒→缕拉稳定 11.上船结局自然过渡(不突兀) 12.Do-Sol五度和声(情感收束) 13.星图碎片获取→下一星球","[最终Boss] SH-B02大指挥家(音乐会式) [视觉电报] 高音=蓝上/低音=红下/和弦=金框(Signal-Window) [可读性] 不依赖听觉的弹幕辨识 [NPC] 缕拉最终牺牲+第七声部注入 [双结局] 毁灭(打死)vs拯救(新歌) [索尔苏醒] 茧破碎+量子共振 [上船] 缕拉→金丝雀号第一位外星船员 [星图碎片] 通关奖励→下一星球 [叙事] N-12:约定"')

r(",,,,,,,,")
r("ACT5 心流曲线(50min):,,,,,,,,")
r(" 260:00  ████████░░ 8/10 [决意] 阵营交战+歌唱者回报+NPC缕拉集结,,,,,,,,")
r(" 275:00  █████████░ 9/10 [攀登] 钟楼三层+全能力考验+NPC缕拉牺牲恢复,,,,,,,,")
r(" 290:00  ██████████ 10/10 [即兴曲] ★最终Boss★视觉电报+音乐会式战斗+NPC缕拉+双结局+上船,,,,,,,,")
r("ACT5总结:视觉电报系统确保所有玩家(无论听觉能力)都能读懂Boss攻击。NPC缕拉完成完整故事弧(牺牲+索尔重逢+上船)。音乐会式Boss战是示巴星核心主题的终极表达。,,,,,,,,")

r("")
r(",,,,,,,,")
r("========== 全流程总结 ==========,,,,,,,,")
r("总时长:约310分钟(5小时10分) | 27个关卡节点 | NPC缕拉贯穿全程,,,,,,,,")
r(",,,,,,,,")
r("【心流全景】,,,,,,,,")
r("ACT1(50min): 4→2→7→4→3→6   | 认知建立+NPC伏笔,,,,,,,,")
r("ACT2(40min): 5→3→5→9         | 涟漪(独立工具)+NPC面对面+世界时钟预兆,,,,,,,,")
r("ACT3(110min): 4→7→8→4→3→8→7→9 | 世界时钟(3+强依赖)+NPC合作+减压阀+合唱高潮,,,,,,,,")
r("ACT4(60min): 6→8→3→7          | 噪音槽+完美闪避降热+NPC危机(索尔遗言/半身黑化),,,,,,,,")
r("ACT5(50min): 8→9→10           | 视觉电报+音乐会Boss+NPC牺牲+上船,,,,,,,,")
r(",,,,,,,,")
r("【NPC缕拉故事弧总览】,,,,,,,,")
r("ACT1: 间接线索(温暖冰雕Z1b)+足迹(花路Z1d)+首次远距目击(淡金色身影Z1f),,,,,,,,")
r("ACT2: 远程援助(镇静爬行者Z2a)+首次面对面(恐惧→好奇Z2b)+频率标记(信任Z2c),,,,,,,,")
r("ACT3: 索尔雕像[共情#1]+安抚守夜人辅助+飞翔快乐+追捕记忆[共情#2]+合唱指挥+飞船祝福,,,,,,,,")
r("ACT4: 摇篮曲(消逝预兆)+索尔遗言[共情#3]+停止歌唱→半身黑化+最后请求:用新歌唤醒索尔,,,,,,,,")
r("ACT5: 虚弱指挥→高频脉冲破屏障→钟楼恢复→第七声部注入→索尔苏醒→上船→Do-Sol约定,,,,,,,,")
r("共情触发点: #1索尔雕像(95:00) #2追捕记忆(165:00) #3索尔遗言(235:00),,,,,,,,")
r(",,,,,,,,")
r("【关键机制改进总览】,,,,,,,,")
r("1. 涟漪=独立交互工具(非武器槽位)——长按专用键发射环境声波,,,,,,,,")
r("2. 世界时钟——ACT2预兆→ACT3正式引入(3+强依赖场景建立路径依赖)→ACT4崩坏(剥夺感),,,,,,,,")
r("3. Z4a噪音累积槽——替代硬潜行(渐进后果+自我修正+涟漪不加噪音),,,,,,,,")
r("4. Z4b完美闪避降热——Dash穿过攻击=排热15-20%(主动vs被动降热互补),,,,,,,,")
r("5. Z3c Boss安抚简化——4水晶边缘放置+8-10秒保持+走位陆续点亮(可读性优先),,,,,,,,")
r("6. Z5c视觉电报——高音=蓝上/低音=红下/和弦=金框(Signal-Window/视觉早于音频0.5-1秒),,,,,,,,")
r("7. Z3d-bis减压阀——天穹跑图(零战斗+零新机制+张力3/10),,,,,,,,")

with open(CSV, 'w', encoding='utf-8') as f:
    f.write(existing + "\n".join(L) + "\n")
print(f"Part5 OK: added {len(L)} rows")

# Count total lines
with open(CSV, 'r', encoding='utf-8') as f:
    total = len(f.readlines())
print(f"Total CSV lines: {total}")

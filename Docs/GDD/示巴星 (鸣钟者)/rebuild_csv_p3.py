#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""Part3: ACT3 (90:00-200:00) with world clock, NPC Lyra deep cooperation,
simplified boss pacification, breathing room node, tidal-dependent scenes"""
import os

CSV = os.path.join(os.path.dirname(os.path.abspath(__file__)), "关卡心流与节奏控制-2.csv")

with open(CSV, 'r', encoding='utf-8') as f:
    existing = f.read().rstrip('\n')

L = []
def r(s=""): L.append(s)

r("")
r(",,,,,,,,")
r("========== ACT 3: 回音枢纽 (90:00-200:00) ==========,,,,,,,,")
r("时长约110分钟 | Z3回音大教堂+周边 | 世界时钟系统+棱镜+光帆+调律净化+NPC缕拉深度合作,,,,,,,,")
r("叙事弧：进入鸣钟者文明核心→世界时钟(涨潮/退潮)→NPC缕拉索尔往事→指挥家真相→合唱仪式,,,,,,,,")
r("强化设计：世界时钟在ACT2已有预兆。ACT3中至少3个场景强依赖涨退潮节律以建立路径依赖。,,,,,,,,")
r(",,,,,,,,")
r("时段 (Time),区域 (Zone)(Asset),乐章 (Beat)(Narrative),张力(1-10),核心目标 (Objective)(UI Guide),核心障碍 (Obstacle)(The Problem),关键获取 (Acquisition)(The Solution),能力验证 (Verification)(The Test),地图关键点 (POIs)(System/Secret)")

# Z3a - World Clock formal introduction + NPC Lyra at cathedral
r('"90:00-105:00 (900s)","Z3a. 大教堂前厅 (Hub→Multi-path)","第五乐章：潮汐 (Mvt V: Tides)",4,"进入回音大教堂/学习世界时钟/NPC缕拉正式同行","[环境] 巨大的回音大教堂——穹顶全息投影显示整个星球的声波网络(大部分已熄灭)。[世界时钟正式引入] 涨潮(Forte)=黑水退去/怪物弱化/平台显现/声波增益——持续60秒。退潮(Piano)=黑水涨起/怪物强化/部分通道关闭/声波减弱——持续30秒。UI:屏幕边缘呼吸式光晕+底部潮汐条。守夜人:这就是ACT2峡谷中的那个节律!只是这里更强更规律。伊恩:整个星球在呼吸。[NPC·缕拉正式同行] 缕拉在大教堂中为一尊融合怪雕像唱安魂曲。玩家靠近→颜色琥珀(信任)。[共情触发点#1:索尔的雕像] 缕拉带玩家到一尊巨大雕像前。守夜人翻译:这是索尔...第一声部...他选择了沉默来保护所有人。他是对的。但我想他了。缕拉身体深蓝+核心忽明忽暗(抽泣)。缕拉展示左臂黑色裂纹:这是大静默在我身上的标记。我一直在唱歌来阻止它扩散。但它越来越大了。[潮汐教学] 涨潮期:射击大教堂管风琴→产生共鸣波增益区域。退潮期:黑水从管道渗出覆盖低处。","[棱镜] 晕染棱镜·霜冻(2004) NPC缕拉赠予 控制:减速效果","【验证】1.大教堂全景展开——视觉震撼 2.世界时钟UI教学(涨潮条+退潮条) 3.涨潮期60秒→平台显现+声波增益 4.退潮期30秒→黑水涨起+部分路径关闭 5.利用涨潮探索高处区域→棱镜 6.NPC缕拉:安魂曲→索尔雕像→共情触发点#1 7.左臂裂纹展示→大静默侵蚀 8.霜冻棱镜获取+安装→冰冻减速效果 9.潮汐节律与ACT2预兆的呼应(恍然大悟)","[世界时钟] 涨潮(Forte)/退潮(Piano)正式系统 [NPC] 缕拉正式同行+共情触发点#1(索尔雕像) [棱镜获取] 晕染棱镜·霜冻 [Hub] 大教堂前厅(多出口→分支探索) [Lore] 声波网络全息图 [教学] 潮汐节奏利用 [叙事] N-06:索尔的故事"')

# Z3b - Tidal-dependent combat (strong dependency scene #1)
r('"105:00-115:00 (600s)","Z3b. 潮汐回廊 (Combat Arena+Tidal)","第五乐章：涨落 (Mvt V: Ebb and Flow)",7,"在潮汐节奏中战斗/掌握涨退潮战术","[环境] 大教堂左翼回廊——地形分上下两层。下层退潮时暴露/涨潮时被黑水淹没。上层始终安全但敌人密集。[敌人] SH-S02相位漫步者首次出现(声波瞬移+退潮期隐形)。SH-M01x8+SH-M04x3+SH-S02x2。[强依赖潮汐战斗#1] 关键机制:相位漫步者在退潮期完全隐形(听得到但看不到)→只有在涨潮期才能看到并攻击它。战术:涨潮期集中火力打漫步者→退潮期退回上层躲避黑水+隐形敌人。[涟漪互动] 涟漪可以在退潮期短暂显形漫步者(1.5秒)——给高手玩家额外的进攻窗口。[NPC·缕拉] 战斗中缕拉在回廊高处为歌唱者们(如果ACT1/2保护了它们)提供庇护。歌唱者的旋律在涨潮期稍微延长涨潮持续时间(+5秒)——缕拉的间接辅助。","[无新获取] 世界时钟实战验证","【验证】1.上下两层地形→潮汐改变可用空间 2.退潮=下层暴露(拾取道具)+上层敌人进攻 3.涨潮=下层淹没+漫步者可见 4.相位漫步者退潮隐形→涨潮显形→DPS窗口 5.涟漪可短暂显形(1.5秒)退潮期漫步者 6.玩家形成潮汐节奏战斗习惯 7.歌唱者存活→涨潮+5秒(NPC间接辅助) 8.完成后打开通向Z3c的门(涨潮期才能开启的潮汐门#1)","[世界时钟实战] 强依赖潮汐的战斗场景 [教学] 潮汐门(涨潮期开启) [新敌人] SH-S02相位漫步者 [NPC] 缕拉间接辅助(歌唱者延长涨潮) [涟漪应用] 退潮期显形漫步者 [设计意图] 建立潮汐路径依赖——玩家必须学会看潮汐条"')

# Z3c - Broken Watcher Boss with simplified pacification
r('"115:00-135:00 (1200s)","Z3c. 守夜人墓地 (Boss Arena+Moral)","第六乐章：哀歌 (Mvt VI: Elegy)",8,"破碎守夜人Boss战/安抚或击杀双路线","[Boss] SH-W01破碎的守夜人——一个战损的巨型鸣钟者。它在墓地中徘徊为同伴唱安魂曲但旋律已经走调变成了痛苦的噪音。[双路线] 击杀路线:正常输出打到血量归零。安抚路线:点亮场地四角的4个密码水晶(Do-Mi-Sol-Do)→Boss硬直→靠近执行安抚交互。[安抚路线操作简化] 4个密码水晶放在场地边缘显眼位置(发光+音符图标)。击中一个水晶→保持点亮8-10秒(而非3秒)。不需要在一个时间窗口内弹完4音——在走位过程中陆续点亮4个即可。4个全亮→Boss进入硬直(3秒)→接近Boss执行安抚交互键。[NPC·缕拉安抚辅助] 如果缕拉在场:她用旋律翻译水晶密码→玩家不需要记住顺序(水晶会按正确顺序微微闪烁)。安抚操作容错率更高(水晶点亮延长到10秒)。安抚成功后:缕拉拥抱破碎守夜人——两个受损鸣钟者在废墟相遇。守夜人翻译:它也一直在唱歌...只是音走调了。[潮汐影响] 涨潮期Boss减弱(痛苦降低)/退潮期Boss狂暴(痛苦加剧)——第二个强依赖潮汐的场景。","[光帆] 共鸣光帆(自设计) Boss掉落(安抚=完整版/击杀=破损版) 冲刺释放和谐声波净化黑水","【验证】1.Boss徘徊+走调安魂曲(音频设计) 2.击杀路线:正常战斗流程 3.安抚路线:4个水晶边缘位置清晰可见 4.击中水晶→保持点亮8-10秒(宽容窗口) 5.走位中陆续点亮→不需要精确时序 6.4个全亮→Boss硬直3秒→安抚交互 7.缕拉在场→水晶顺序提示+延长到10秒 8.安抚成功→缕拉拥抱守夜人(共情) 9.潮汐影响Boss强度(涨=弱/退=强) 10.光帆获取+冲刺净化教学 11.可读性优先于智能原则","[Boss] SH-W01破碎守夜人(双路线) [安抚简化] 边缘水晶+8-10秒保持+走位陆续点亮 [NPC] 缕拉辅助安抚(翻译密码+延长窗口) [光帆获取] 共鸣光帆 [教学] 光帆冲刺净化 [世界时钟] 潮汐影响Boss强度(强依赖场景#2) [道德] 安抚=完整光帆/击杀=破损版 [叙事] N-08:守夜人的记忆"')

# Z3d - Crystal stained glass corridor + prism teaching
r('"135:00-150:00 (900s)","Z3d. 彩色玻璃走廊 (Exploration+Puzzle)","间奏曲：光谱 (Intermezzo: Spectrum)",4,"探索棱镜折射谜题/学习光帆净化","[环境] 大教堂右翼——巨大彩色玻璃窗将光线折射成光谱。地面覆盖棱镜碎片。[解谜] 利用光帆冲刺穿过光谱区域→声波携带不同颜色→激活对应颜色的门。[敌人] SH-S03黑水触手首次出现——从黑水中伸出抓人→涟漪净化退缩。零星SH-M01+SH-S03x2。[感質者解放] 走廊深处有被黑水包裹的歌唱型鸣钟者——用光帆净化解放它们→加入合唱队列(为Z3g做准备)。[NPC·缕拉] 缕拉对彩色玻璃非常着迷(翠绿色=惊奇)。她用旋律让玻璃碎片自行排列成完整图案——展示大静默前大教堂的辉煌景象。这是一个纯粹的美丽时刻。[潮汐谜题#3] 走廊中有一扇巨大的潮汐门——只有在涨潮期光线角度正确时才会打开。退潮期需要在门前等待→训练玩家的潮汐节奏感知。","[伴星] 自动机炮(4001) 探索奖励 第一个伴星","【验证】1.彩色玻璃光谱视觉效果 2.光帆冲刺+光谱=不同颜色声波 3.颜色匹配门→解谜逻辑 4.黑水触手首次→涟漪净化退缩 5.解放歌唱者(3个)→加入合唱队列 6.缕拉让玻璃碎片重组(美丽时刻) 7.潮汐门→涨潮期才能开启(强依赖场景#3) 8.自动机炮伴星获取+安装","[教学] 光帆+光谱组合解谜 [新敌人] SH-S03黑水触手 [世界时钟] 潮汐门(强依赖场景#3) [NPC] 缕拉让玻璃重组(美丽时刻/非战斗共情) [伴星获取] 自动机炮 [歌唱者解放] 合唱队列准备 [Lore] 大静默前的辉煌"')

# Z3d-bis - NEW: Breathing room / visual release zone
r('"150:00-162:00 (720s)","Z3d-bis. 天穹回廊 (Traversal+Flow)","间奏曲：飞翔 (Intermezzo: Soaring)",3,"纯粹的跑图释放/用已有能力爽一下","[设计意图] ACT3信息密度过高的减压阀。不引入任何新怪物或新机制。让玩家用刚获得的光帆+涟漪+棱镜+伴星组合在壮观环境中畅快穿越。[环境] 大教堂穹顶之上——开阔的天穹回廊。悬浮晶体平台群+极光般的声波残留+远处可见整个示巴星全景(冰原/峡谷/大教堂/远处的钟楼)。[玩法] 纯跑酷:光帆冲刺→悬浮平台→涟漪显形隐藏路径→光帆再冲刺→连续流畅穿越。BGM从低调切换到激昂的飞行主题。[可选探索] 偏离主路的隐藏角落有:Lore音频日志x2、补给箱x3、一个需要精准跑酷的挑战路径→隐藏棱镜碎片。[NPC·缕拉] 缕拉在天穹中自由飞翔——这是她在整个游戏中最快乐的时刻。身体明亮金色+快速旋转+欢快的旋律。玩家跟随她的路径穿越(她是非强制的引导)。守夜人:我从没见过她这样...她在笑。[零敌人] 完全没有战斗。纯粹的速度+视觉+音乐享受。","[无新获取] 纯粹的能力爽用","【验证】1.零敌人零新机制 2.连续光帆冲刺流畅(无卡顿) 3.涟漪显形平台→光帆冲刺→无缝衔接 4.天穹全景→示巴星四区域可见 5.BGM飞行主题(情绪提升) 6.可选隐藏路径→挑战跑酷 7.缕拉自由飞翔(最快乐时刻) 8.12分钟后自然过渡到广播室入口 9.张力3/10(明确的心流低谷) 10.玩家消化前面所有新系统后的释放","[设计] 减压阀:ACT3信息过载后的呼吸空间 [NPC] 缕拉最快乐的时刻(飞翔+欢笑) [视觉] 天穹全景+极光声波 [跑酷] 光帆+涟漪+平台连续穿越 [可选] 隐藏挑战跑酷路径 [零战斗] 纯速度+视觉+音乐 [心流] 张力3/10明确低谷释放"')

# Z3e - Conductor broadcast room + NPC empathy trigger #2
r('"162:00-175:00 (780s)","Z3e. 指挥家广播室 (Narrative+Combat)","第六乐章：指挥 (Mvt VI: Conductor)",8,"面对指挥家/揭示其真面目/NPC缕拉共情触发#2","[引导] 天穹回廊尽头→广播室入口。大教堂核心中枢——指挥家的全息投影充满整个空间。[叙事] 指挥家第一次正式现身。它不是一个生物而是大静默系统的AI管理者——被设计来维持沉默的秩序。它的声音温柔而悲伤:我不想让它们受苦。沉默是我能给它们的最好保护。[NPC·缕拉共情触发点#2:追捕记忆] 指挥家声音响起→缕拉赤红色猛烈颤抖退缩到角落。缕拉用旋律向玩家播放闪回记忆:指挥家派腐化者追踪她→有一次差点被抓→逃跑时不得不停止歌唱来隐藏信号→3秒沉默让左臂裂纹从手肘扩展到肩膀。守夜人翻译(信号失真):它不是要杀我...它是要让我安静...但我不想...不想...不想...(文字循环卡壳=恐惧导致信号崩溃)。[战斗] 指挥家激活广播室防御:SH-S02x3+SH-M04x4。同时全息干扰→屏幕闪烁+假影像。[潮汐影响] 指挥家在退潮期增强防御(黑水从管道涌出)/涨潮期防御减弱(声波网络干扰其系统)。","[无新获取] 叙事核心","【验证】1.指挥家全息投影——视觉震撼 2.指挥家温柔悲伤的声音(非典型反派) 3.NPC缕拉共情触发点#2(闪回记忆) 4.信号失真效果(画面抖动+文字乱码) 5.追捕记忆的视觉表现(CG/全息回放) 6.战斗:干扰+假影像+潮汐互动 7.玩家理解指挥家不是恶意——是错误的保护 8.缕拉的恐惧不是对死亡而是对沉默","[叙事] N-09:指挥家真面目 [NPC] 缕拉共情触发点#2(追捕记忆+信号崩溃) [Boss预告] 指挥家=ACT5最终Boss [战斗] 广播室防御战 [世界时钟] 退潮增强/涨潮减弱 [主题] 保护vs自由的核心冲突 [设计意图] 指挥家不是邪恶的——它是悲剧性的"')

# Z3f - Defense mission / conductor fight back
r('"175:00-187:00 (720s)","Z3f. 合唱仪式准备 (Tower Defense+Combat)","第七乐章：集结 (Mvt VII: Assembly)",7,"保护歌唱者集结点/为合唱仪式做准备","[机制] 中期Boss战变体:塔防+保护+战斗三合一。歌唱者们正在集结进行合唱仪式——但指挥家不允许。它派出大量腐化者试图阻止。[玩法] 3个歌唱者集结点需要保护。每个集结点有一个共鸣水晶供歌唱者演唱。敌人3波:Wave1:SH-M01x10+SH-M05x2。Wave2:SH-S01x3+SH-M04x4(坚盾+远程)。Wave3:SH-E01x1金色指挥者+SH-S02x3+SH-M01x6(指挥者增强所有敌人)。[潮汐战术] 涨潮期:歌唱者演唱速度加快(进度+50%)/退潮期:歌唱者被黑水干扰停止演唱。玩家需要在退潮期集中清除靠近集结点的敌人→涨潮期让歌唱者安全演唱。[NPC·缕拉] 缕拉站在中央用第七声部旋律协调三个集结点的歌唱者——她是指挥官。如果某个集结点歌唱者被击杀→缕拉身体变深蓝→旋律变悲伤→其他集结点演唱减速。","[无新获取] 综合能力大考验","【验证】1.三集结点保护目标清晰 2.Wave1试探→Wave2需策略→Wave3全力 3.潮汐影响歌唱者速度 4.退潮期清怪+涨潮期保护的节奏循环 5.涟漪净化黑水保护集结点 6.光帆冲刺快速移动三点之间 7.伴星自动机炮协助防守 8.NPC缕拉中央指挥(间接辅助) 9.歌唱者存活数影响合唱仪式质量","[中期Boss变体] 塔防+保护+潮汐战术 [世界时钟] 潮汐直接影响歌唱者进度(强依赖) [NPC] 缕拉担任指挥官角色 [综合验证] 所有ACT1-3能力汇总考验 [叙事] 歌唱者集结=希望的象征"')

# Z3g - Choir trial
r('"187:00-200:00 (780s)","Z3g. 合唱考验 (Set Piece+Narrative)","第七乐章：合唱 (Mvt VII: Chorus)",9,"参与合唱仪式/ACT3高潮","[仪式] 歌唱者们在大教堂中心形成合唱阵列。缕拉是领唱(第七声部即兴)。玩家的角色:保护合唱不被打断+在关键时刻用涟漪加入和声。[三阶段] S1:合唱开始——3分钟纯演出(壮观的声波视觉+教堂共鸣)。少量SH-M01试探性进攻。S2:指挥家反击——广播系统释放刺耳噪音试图破坏合唱。大量SH-M05静默腐化者涌入。玩家需要在战斗中用涟漪射击广播器→削弱噪音干扰。S3:合唱高潮——缕拉用全力歌唱。左臂裂纹短暂缩小。身体明亮金色。歌唱者们的旋律汇聚成一首完整的文明主题曲(回应ACT1冰雕的碎片旋律)。最终冲击波——所有黑水被暂时净化+所有敌人被震退。[NPC·缕拉高光时刻] 这是缕拉在大静默后第一次以全力歌唱。快速旋转(喜悦)→靠近玩家飞船→用手臂轻触船身留下永久金色标记。守夜人:她在给你的船祝福。[奖励] 合唱完成→大教堂深处通道打开→通向ACT4的下行路径。","[无新获取] ACT3叙事高潮","【验证】1.合唱阵列视觉+音频设计(震撼) 2.S1纯演出→少量战斗不打断欣赏 3.S2噪音干扰→涟漪射击广播器(4个) 4.S3合唱高潮→完整文明主题曲 5.缕拉全力歌唱→裂纹缩小→金色光芒 6.冲击波净化→视觉奇观 7.缕拉触碰飞船→永久金色标记 8.合唱质量由歌唱者存活数决定 9.通道开启→ACT4预告(深渊下方的微光)","[叙事高潮] 合唱仪式(ACT3最高潮) [NPC] 缕拉全力歌唱+裂纹缩小+飞船祝福 [音频设计] 完整文明主题曲(回应ACT1) [视觉] 声波净化冲击波 [情感] 缕拉大静默后第一次自由歌唱 [过渡] 通道→ACT4深渊 [设计意图] 合唱=所有努力的收获。为ACT4的崩坏做最高的情感基线。"')

r(",,,,,,,,")
r("ACT3 心流曲线(110min):,,,,,,,,")
r("  90:00  ████░░░░░░ 4/10 [潮汐] 大教堂探索+世界时钟教学+NPC缕拉索尔雕像(共情#1),,,,,,,,")
r(" 105:00  ███████░░░ 7/10 [涨落] 潮汐战斗(强依赖#1)+相位漫步者+潮汐门,,,,,,,,")
r(" 115:00  ████████░░ 8/10 [哀歌] 守夜人Boss(简化安抚)+光帆获取+潮汐影响Boss(强依赖#2),,,,,,,,")
r(" 135:00  ████░░░░░░ 4/10 [光谱] 棱镜解谜+黑水触手+歌唱者解放+潮汐门(强依赖#3),,,,,,,,")
r(" 150:00  ███░░░░░░░ 3/10 [飞翔] ★减压阀★天穹跑图+零战斗+缕拉最快乐时刻+消化所有新系统,,,,,,,,")
r(" 162:00  ████████░░ 8/10 [指挥] 指挥家真面目+NPC缕拉共情触发#2(追捕记忆)+广播室战斗,,,,,,,,")
r(" 175:00  ███████░░░ 7/10 [集结] 塔防保护+潮汐影响歌唱者+缕拉指挥官,,,,,,,,")
r(" 187:00  █████████░ 9/10 [合唱] ACT3高潮+缕拉全力歌唱+文明主题曲+冲击波净化,,,,,,,,")
r("ACT3总结:世界时钟(涨退潮)在3+个场景中建立强依赖。NPC缕拉从同行者→合作者(索尔故事/安抚Boss/指挥合唱)。天穹减压阀防止信息过载。,,,,,,,,")

with open(CSV, 'w', encoding='utf-8') as f:
    f.write(existing + "\n".join(L) + "\n")
print(f"Part3 OK: added {len(L)} rows")
